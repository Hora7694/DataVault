<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualiseur - DataVault</title>
    <link rel="stylesheet" href="index.css">
    <style>
        .cell-image {
            max-width: 50px;
            max-height: 50px;
            object-fit: contain;
            display: block;
            margin: auto;
        }
        .tag-pill {
            display: inline-block;
            background: var(--tag-pill-bg);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            color: var(--tag-pill-text);
            border: 1px solid var(--border-color);
            margin: 2px;
            white-space: nowrap; /* √âvite que les tags se coupent en deux */
        }
    </style>
</head>
<body>
    <button id="theme-toggle">üåô</button>
    
    <div style="padding: 20px;">
        <button onclick="window.history.back()" class="btn-back">‚Üê Retour</button>
        
        <div style="display: flex; align-items: center; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
            <h1 id="display-alias" style="margin: 0; white-space: nowrap;">Chargement...</h1>
            <a id="download-btn" href="#" download>
                <button style="background-color: #5553ff; padding: 8px 15px; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                    T√©l√©charger CSV
                </button>
            </a>
        </div>
        <p id="display-path" style="color: #888; font-size: 0.85em; margin-top: 5px; font-family: monospace;"></p>
    </div>

    <div id="table-container" style="overflow-x: auto;"></div>

    <footer style="text-align: center; padding: 40px; border-top: 1px solid #eee; font-size: 0.85em; color: #888;">
        <p>Base de donn√©es cr√©√©e par <strong id="display-author">...</strong></p>

        <div style="margin: 20px 0;">
            <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
            <script type='text/javascript'>
                kofiwidget2.init('Soutenir DataVault', '#5553ff', 'T6T117BAZT');
                kofiwidget2.draw();
            </script>
        </div>
        
        <p id="display-image-author-container" style="display:none;">Images fournies par : <strong id="display-image-author"></strong></p>
        <p>Donn√©es de <span id="display-owner">...</span> &copy; Tous droits r√©serv√©s.</p>
    </footer>

    <script>
        async function loadCSV() {
            const container = document.getElementById('table-container');
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const filePath = urlParams.get('file');
                const imageAuthor = urlParams.get('image_author');

                if (!filePath) throw new Error("Aucun fichier sp√©cifi√©.");

                document.getElementById('display-alias').textContent = urlParams.get('alias') || "Fichier";
                document.getElementById('display-path').textContent = filePath;
                document.getElementById('display-owner').textContent = urlParams.get('owner') || "Inconnu";
                document.getElementById('display-author').textContent = urlParams.get('author') || "Anonyme";
                document.getElementById('download-btn').href = filePath;

                if (imageAuthor && imageAuthor !== "" && imageAuthor !== "null" && imageAuthor !== "undefined") {
                    document.getElementById('display-image-author').textContent = imageAuthor;
                    document.getElementById('display-image-author-container').style.display = 'block';
                }

                const response = await fetch(filePath);
                if (!response.ok) throw new Error("Fichier introuvable.");

                const text = await response.text();
                const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                
                let html = '<table><thead><tr>';
                const headers = parseCSVLine(rows[0]);
                headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';

                rows.slice(1).forEach(row => {
                    const cells = parseCSVLine(row);
                    html += '<tr>';
                    cells.forEach(val => {
                        let cleanVal = val.trim().replace(/^"|"$/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').trim();
                        
                        // 1. D√©tection Image
                        const isImgUrl = cleanVal.startsWith('http') && (cleanVal.match(/\.(jpeg|jpg|gif|png|webp|svg)/i) || cleanVal.includes("static.wikia.nocookie.net"));

                        if (isImgUrl) {
                            html += `<td><img src="${cleanVal}" class="cell-image" referrerpolicy="no-referrer" onerror="this.style.display='none'"></td>`;
                        } 
                        // 2. D√©tection des TAGS (On √©vite de transformer les prix et les nombres d√©cimaux)
                        else if (cleanVal.includes(',') && !cleanVal.includes('‚Ç¨') && isNaN(cleanVal.replace(',', '.'))) {
                            const tags = cleanVal.split(',').map(t => `<span class="tag-pill">${t.trim()}</span>`).join('');
                            html += `<td>${tags}</td>`;
                        } 
                        // 3. Texte normal (Prix, Descriptions, Nombres)
                        else {
                            html += `<td>${cleanVal}</td>`;
                        }
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div style="padding: 20px; color: red;">Erreur: ${err.message}</div>`;
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let curValue = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(curValue.trim());
                    curValue = '';
                } else curValue += char;
            }
            result.push(curValue.trim());
            return result;
        }

        loadCSV();

        const btn = document.getElementById('theme-toggle');
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            btn.textContent = '‚òÄÔ∏è';
        }
        btn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });
    </script>
</body>
</html>
